---
title: Fly.ioã«FastAPI + PostgreSQLã®ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸ
tags:
  - Python
  - PostgreSQL
  - sqlalchemy
  - fly.io
  - FastAPI
private: false
updated_at: '2024-05-16T20:36:18+09:00'
id: 454fe7b7aef2f9326c04
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
ä»¥ä¸‹æ§‹æˆã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç’°å¢ƒã‚’Fly.ioã«åˆã‚ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã®ã§ã€ãã®æ™‚ã®æ‰‹é †ã‚’å…±æœ‰ã—ã¾ã™ã€‚
- FastAPIï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠï¼‰
    - SQLAlchemyï¼ˆORMï¼‰
    - Psycopgï¼ˆPostgreSQLç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰
    - Alembicï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®Migrationãƒ„ãƒ¼ãƒ«ï¼‰
- Postgresql

ç‰¹ã«ã€SQLAlchemy+psycopgã‚’ä½¿ã£ã¦Fly.ioã®Postgresqlã«æ¥ç¶šã™ã‚‹å ´åˆã€ã‚¹ãƒ ãƒ¼ã‚ºã«ã„ã‹ãªã‹ã£ãŸã®ã§ãã®ã‚ãŸã‚Šã®ãƒŠãƒ¬ãƒƒã‚¸ã‚‚æ®‹ã—ã¦ãŠã“ã†ã¨æ€ã„ã¾ã™ã€‚

# å¯¾è±¡èª­è€…
- Fly.ioã«FastAPI + Postgresqlã®ç’°å¢ƒã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„æ–¹
- Fly.ioã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®æµã‚Œã‚„ä½¿ã„æ–¹ã‚’ã–ã£ãã‚ŠçŸ¥ã‚ŠãŸã„æ–¹

# æœ¬è¨˜äº‹ã®å‰æ
## é–‹ç™ºç’°å¢ƒ
- MacOS 14.4.1
- Docker Desktop for Mac

## ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®FastAPIã¨Postgresqlã®ã‚³ãƒ³ãƒ†ãƒŠ
- FastAPIã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã¯Dockerfileã‹ã‚‰ä½œæˆ
```dockerfile: Dockerfile
FROM python:3.11-slim

RUN apt-get update && apt-get install -y \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .

RUN pip install poetry
RUN poetry install --no-interaction --no-ansi

EXPOSE 8000

CMD ["poetry", "run", "uvicorn", "--host", "0.0.0.0", "test_app.app:app"]
```

- FastAPIã¨Postgresqlã¯ä»¥ä¸‹ã®`compose.yaml` ã§èµ·å‹•
    - Postgresqlã¸ã®æ¥ç¶šæ–‡å­—åˆ—ã‚’ç’°å¢ƒå¤‰æ•°ã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
```yaml: compose.yaml
services:
  db:
    image: postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: test_user
      POSTGRES_DB: test_db
      POSTGRES_PASSWORD: test_password
    ports:
      - "5432:5432"

  app:
    image: test_app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      # psycopgã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ä½¿ç”¨
      DATABASE_URL: postgresql+psycopg://test_user:test_password@test_db:5432/app_db
volumes:
  pgdata:
```
:::note info
ã‚³ãƒ³ãƒ†ãƒŠã®ç’°å¢ƒå¤‰æ•°ã¯`.env`ç­‰ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ä¾¿å®œçš„ã«compose.yamlã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚
:::

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
    - Alembicã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
```
.
â”œâ”€â”€ alembic.ini
â””â”€â”€ migrations
    â”œâ”€â”€ env.py
    â”œâ”€â”€ script.py.mako
    â””â”€â”€ versions
        â”œâ”€â”€ 71bfea98db2b_create_todo_table.py # <- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
        â””â”€â”€ 7c2f73b28d63_create_user_table.py  # <- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
```

ä¸Šè¨˜å‰æã®ã‚‚ã¨ã€æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®å†…å®¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚
- Fly.ioã«FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- Postgresqlãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã€Fly.ioãŒæä¾›ã™ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹
- ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸFastAPIã«sshæ¥ç¶šã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹

# Fly.ioã¨ã¯ï¼Ÿ
Fly.ioã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§ç°¡å˜ã«èµ·å‹•ã§ãã‚‹PaaSï¼ˆPlatform as a Serviceï¼‰å‹ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚

https://fly.io/

å¤šãã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«å¯¾å¿œã—ã¦ãŠã‚Šã€ç‰¹ã«Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¦ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã§ã™ã€‚
ã¾ãŸã€Fly.ioã¯PostgreSQLã‚„Redisãªã©ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚‚æä¾›ã—ã¦ã„ã¾ã™ã€‚

## Fly.ioã®ç„¡æ–™ãƒ—ãƒ©ãƒ³
Fly.ioã¯ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’æä¾›ã—ã¦ãŠã‚Šã€å€‹äººé–‹ç™ºç­‰ã§ã¡ã‚‡ã£ã¨è©¦ã—ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹ç’°å¢ƒã«ã¯ã¡ã‚‡ã†ã©ã„ã„ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ãŒç„¡æ–™ã§ä½¿ãˆã¾ã™ã€‚



- æœ€å¤§3ã¤ã®shared-cpu-1x 256MB VMs
- 3GBã®æ°¸ç¶šãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- åˆè¨ˆ160GBã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿è»¢é€

è©³ç´°ã¯ä»¥ä¸‹å‚ç…§ã€‚

https://fly.io/docs/about/pricing/#new-customers-get-a-free-trial

---
ãã‚Œã§ã¯ã“ã“ã‹ã‚‰Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚

# â‘ Fly.ioã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
ã¾ãšã¯Fly.ioã®ä»¥ä¸‹ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

https://fly.io/app/sign-in

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/198688d1-3f81-d6ec-1440-6a164540de0c.png)


## ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹
ç„¡æ–™æ ãŒä»˜ã„ã¦ã„ã‚‹ã‚‚ã®ã®ã€Fly.ioãŒæä¾›ã™ã‚‹Postgresqlã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ç™»éŒ²ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§ç™»éŒ²ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚[^1]

- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹`Add a payment method to keep using our platform.`ã‚’ã‚¯ãƒªãƒƒã‚¯
- ä»¥ä¸‹ã®Hobby Planã®ä¸‹ã«ã‚ã‚‹`Continue`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/ff95047d-8f6f-f5fb-0cbc-7b898cfc6d0d.png)
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«$5.00ã®åˆ©ç”¨ãŒã§ãã‚‹æ—¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OK
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/34201b6d-7692-2abf-9521-a35b128031cc.png)


# â‘¡`flyctl`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
Fly.ioã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰æ“ä½œã™ã‚‹ãŸã‚ã®CLIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ `flyctl` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã¯ã€**[å…¬å¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰](https://fly.io/docs/hands-on/install-flyctl/)** ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§flyctlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
```bash
$ flyctl version
flyctl v0.2.50 darwin/arm64 Commit: b699e9.... BuildDate: 2024-05-08T14:04:18Z
```

# â‘¢`flyctl`ã‹ã‚‰Fly.ioã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
`flyctl`ã‹ã‚‰Fly.ioã‚’æ“ä½œã™ã‚‹ãŸã‚ã®æº–å‚™ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã„ã¾ã™ã€‚
```bash
$ flyctl auth login
Opening https://fly.io/app/auth/cli/223fascc23411973591eeaee63e2 ...

Waiting for session...
```

ä¸Šè¨˜ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã€ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€ä½œæˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/84ac0225-fa10-dc28-56c6-069dc50ab64b.png)

ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ãŒæˆåŠŸã—ãŸæ—¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚
```bash
...
Waiting for session... Done
successfully logged in as <ãƒ­ã‚°ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹>
```
ä»¥é™ã€`flyctl`ã‚’ä½¿ã£ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã—ã¦ã„ãã¾ã™ã€‚

# â‘£Fly.ioã«Appsã‚’ä½œæˆã™ã‚‹
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ã€ã¾ãšã¯æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆFly.ioã®`Apps`ã¨ã„ã†ã‚‚ã®ï¼‰ã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¾ã™ã€‚
```bash
$ flyctl launch --no-deploy
```

- `flyctl launch`
    - Fly.ioä¸Šã«æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã«å¿…è¦ãª`fly.toml`ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«ç”Ÿæˆã•ã‚Œã‚‹

- `--no-deployã‚ªãƒ—ã‚·ãƒ§ãƒ³`
    - å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯è¡Œã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    - ã“ã†ã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚„ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
```bash
$ flyctl launch --no-deploy
Scanning source code
Detected a Dockerfile app
Creating app in /<youre-directory>
We're about to launch your app on Fly.io. Here's what you're getting:

Organization: <account name>         (fly launch defaults to the personal org)
Name:         fly-demo               (derived from your directory name)
Region:       Hong Kong, Hong Kong   (this is the fastest region for you)
App Machines: shared-cpu-1x, 1GB RAM (most apps need about 1GB of RAM)
Postgres:     <none>                 (not requested)
Redis:        <none>                 (not requested)
Sentry:       false                  (not requested)

? Do you want to tweak these settings before proceeding? (y/N) 
```

ä¸Šè¨˜ã®è¡¨ç¤ºå†…å®¹ã«ã¤ã„ã¦ã€ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ä»¥ä¸‹ã§ã™ã€‚
- ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«DockerfileãŒå­˜åœ¨ã™ã‚‹å ´åˆã€`flyctl`ãŒè‡ªå‹•çš„ã«æ¤œå‡ºã—ã¦ãã‚Œã‚‹ï¼ˆ3è¡Œç›®ï¼‰
- `Organization:` ä»¥é™ã¯ã€ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ç¤ºã—ã¦ã„ã‚‹
    - ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ (ãªãœã‹Hong Kongã«ãªã£ã¦ã„ã‚‹ãƒ»ãƒ»ãƒ»)
    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œãƒã‚·ãƒ³æ§‹æˆï¼ˆ`shared-cpu-1x, 1GB RAM`ï¼‰
    - Postgres ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¨­å®šãªã—ï¼‰

æœ€å¾Œã«`Do you want to tweak these settings before proceeding? (y/N) ` ã¨èã‹ã‚Œã¾ã™ãŒã€ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰å¤‰æ›´ã—ãŸã„ã®ã§ `y` ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

ãã†ã™ã‚‹ã¨ã€å†ã³ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ãã€ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ãã‚Œãã‚Œè¨­å®šã‚’å¤‰æ›´ã—ã¦ã„ãã¾ã™ã€‚

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/91d899c3-fc47-82bd-4de6-ccf3f350c7c4.png)



ç§ã®å ´åˆã¯ã€Fly.ioã®ãŠè©¦ã—åˆ©ç”¨ãŒç›®çš„ã ã£ãŸã®ã§ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã‚„å¯ç”¨æ€§ã¯ã™ã¹ã¦æœ€å°æ§‹æˆã«ã—ã¾ã—ãŸã€‚
ã¾ãŸã€Postgresqlã‚’ä½¿ã†ã®ã§Databaseã®è¨­å®šã‚’å…¥åŠ›ã—ã¦ã„ã¾ã™ã€‚

å…¥åŠ›å¾Œã€`Confirm Settings`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã‚‹ã¨ã€ä»¥ä¸‹ã®é€šã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŠã‚ˆã³Postgresqlã‚’ä½œæˆã—ãŸæ—¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```diff: flyctl launchã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã®æŠœç²‹
Created app 'fly-demo-test' in organization 'personal'
Admin URL: https://fly.io/apps/fly-demo-test
Hostname: fastzeroapp.fly.dev
Creating postgres cluster in organization personal
Creating app...

...çœç•¥

Postgres cluster fly-demo-test-postgres created
  Username:    postgres
  Password:    YIawXXplW2rRe2b
  Hostname:    fly-demo-test-postgres.internal
  Flycast:     fdaa:9:4169:0:1::2
  Proxy port:  5432
  Postgres port:  5433
+  Connection string: postgres://postgres:YIaPPtXCRrRe2b@fly-demo-test-postgres.flycast:5432

...çœç•¥

Postgres cluster fly-demo-test-postgres is now attached to fly-demo-test
The following secret was added to fly-demo-test:
+ DATABASE_URL=postgres://fly_demo_test:cQv0vvfasf7FM@fly-demo-test-postgres.flycast:5432/fly_demo_test?sslmode=disable
Postgres cluster fly-demo-test-postgres is now attached to fly-demo-test
? Create .dockerignore from .gitignore files? (y/N)
```

ä¸Šè¨˜ã®å·®åˆ†ã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã‚‹ç®‡æ‰€ã¯ã€ä½œæˆã—ãŸPostgresqlãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šæ–‡å­—åˆ—ã§ã™ã€‚
**ã“ã®æƒ…å ±ã¯Fly.ioã®Webç”»é¢ã§ã‚‚é–²è¦§ã§ããªã„æ©Ÿå¯†æƒ…å ±ã«ãªã‚‹ãŸã‚ã€ã“ã®æƒ…å ±ã¯å¤§åˆ‡ã«ä¿ç®¡ã—ã€å…±æœ‰ã¯ã—ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚**

ã¾ãŸã€æœ€å¾Œã®è³ªå•ï¼ˆ`? Create .dockerignore from .gitignore files? (y/N)`ï¼‰ã«ã¤ã„ã¦ã¯ã€`.dockerignore`ãŒå¿…è¦ã§ã‚ã‚Œã°`y`ã«ã—ã¾ã—ã‚‡ã†ã€‚

```bash: flyctl launchã‚³ãƒãƒ³ãƒ‰ã®ç¶šã
? Create .dockerignore from .gitignore files? (y/N) Yes

Created <src-path>/.dockerignore from 4 .gitignore files.
Wrote config file fly.toml
Validating <src-path>/fly.toml
âœ“ Configuration is valid
Your app is ready! Deploy with `flyctl deploy`
```

ä¸Šè¨˜ã®é€šã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™ãŒæ•´ã£ãŸã‚ˆã†ã§ã™ğŸ‰

ã¾ãŸã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹æˆæƒ…å ±ï¼ˆ`fly.toml`ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

# â‘¤ç’°å¢ƒå¤‰æ•°ã‚’Fly.ioã®`Secrets`ã«ç™»éŒ²ã™ã‚‹
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ãŒã‚ã‚‹å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«Fly.ioä¸Šã§èª­ã¿è¾¼ã‚ã‚‹çŠ¶æ…‹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€Fly.ioã§ã¯`Secrets`ã¨ã„ã†æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
`Secrets`ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã«è³‡æ ¼æƒ…å ±ãªã©ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

https://fly.io/docs/reference/secrets/

ã©ã†ã‚„ã£ã¦Secretsã‚’ç™»éŒ²ã™ã‚‹ã‹ã¨ã„ã†ã¨ã€
`flyctl`ã® `secrets set` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ç™»éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ fly secrets set MY_SECRET_NAME="test secret"
```

## SQLAlchemy + Psycopgã§Postgresqlã«æ¥ç¶šã™ã‚‹æ–¹æ³•

æœ¬è¨˜äº‹ã§ã¯ã€å…ƒã€…[`compose.yaml`](https://qiita.com/inetcpl/items/454fe7b7aef2f9326c04#%E3%83%87%E3%83%97%E3%83%AD%E3%82%A4%E5%AF%BE%E8%B1%A1%E3%81%AEfastapi%E3%81%A8postgresql%E3%81%AE%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A)å†…ã§å®šç¾©ã—ã¦ã„ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šæ–‡å­—åˆ— `DATABASE_URL` ã‚’æ‰‹é †â‘£ã§æ‰•ã„å‡ºã•ã‚ŒãŸæ¥ç¶šæ–‡å­—åˆ—ã«å¤‰æ›´ã—ã€ãã®å€¤ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

ç™»éŒ²ã™ã‚‹å‰ã«ã€ã¾ãšã¯`flyctl secrets list`ã§ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```bash
$ flyctl secrets list
NAME            DIGEST                  CREATED AT 
DATABASE_URL    eb0aac24db6ab082        1h10m ago
```

å®Ÿã¯ä¸Šè¨˜ã®é€šã‚Šã€æ‰‹é †â‘£ã‚’å®Ÿè¡Œã—ãŸã¨ãã«DATABASE_URLãŒç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚
å†…å®¹ã¯ä»¥ä¸‹ã®å€¤ã§ã™ã€‚
```bash: flyctl launchã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã®æŠœç²‹
Connection string: postgres://postgres:YIaPPtXCRrRe2b@fly-demo-test-postgres.flycast:5432
```

ãŸã ã—ã€SQLAlchemyã¨Psycopgã‚’ä½¿ã£ã¦Postgresqlã«æ¥ç¶šã—ã¦ã„ã‚‹å ´åˆã€**ä¸Šè¨˜ã®æ¥ç¶šæ–‡å­—åˆ—ã‚’æœ‰åŠ¹ãªå€¤ã¨ã—ã¦èªè­˜ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚**
å…ƒã€…ã€compose.yamlã®`DATABASE_URL`ã§å®šç¾©ã—ã¦ã„ãŸã‚ˆã†ã«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®éƒ¨åˆ†ã‚’`postgresql+psycopg`ã«ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```diff
- postgres://postgres:YIaPPtXCRrRe2b@fly-demo-test-postgres.flycast:5432
+ postgresql+psycopg://postgres:YIaPPtXCRrRe2b@fly-demo-test-postgres.flycast:5432
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç’°å¢ƒå¤‰æ•°`DATABASE_URL`ã‚’ä¿®æ­£ã—ãŸå€¤ã§ä¸Šæ›¸ãç™»éŒ²ã§ãã¾ã™ã€‚
```bash
$ flyctl secrets set DATABASE_URL=postgresql+psycopg://postgres:YIaPPtXCRrRe2b@fly-demo-test-postgres.flycast:5432
Secrets are staged for the first deployment
```

# â‘¥ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€`flyctl deploy`ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
```bash
$ fly deploy --local-only --ha=false
```

- `--local-only`
    - ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®ãƒ“ãƒ«ãƒ‰ç­‰ï¼‰ãŒãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
    - ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãªã„å ´åˆã€ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ã¯Fly.ioä¸Šã§å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚„ãƒ‡ãƒãƒƒã‚°ã‚’ã—ãŸã„å ´åˆã«ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

- `--ha=false`
    - é«˜å¯ç”¨æ€§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ç«‹ã¡ä¸ŠãŒã‚Šã€éšœå®³æ™‚ã«è‡ªå‹•ã§ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ãã‚Œã¾ã™ã€‚
    - ä»Šå›ã¯ç„¡æ–™æ å†…ã§æ¤œè¨¼ã—ãŸã„ã®ã§æœ¬æ©Ÿèƒ½ã‚’Falseã§ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™ã€‚

ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã€ãã®å¾ŒFly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚
```bash
$ fly deploy --local-only --ha=false
==> Verifying app config
Validating <your-directory>/fly.toml
âœ“ Configuration is valid
--> Verified app config
==> Building image
==> Building image with Docker
--> docker host: 25.0.5 linux aarch64
[+] Building 51.0s (12/12) FINISHED                                                                                                                          
 
 ...çœç•¥
 
--> Building image done
==> Pushing image to fly
The push refers to repository [registry.fly.io/fly-demo-test]
8c65950a7b44: Pushed 
afe5e98a69a7: Pushed 
2ff1765ea85f: Pushed 
52664eb4ef6b: Pushed 
b0190595c83a: Pushed 
67704d8b406c: Pushed 
216328af4e79: Pushed 
238975b59c5f: Pushed 
3069e121245c: Pushed 
146826fa3ca0: Pushed 
5d4427064ecc: Pushed 
deployment-01HY09TSQNFP1FB83CXDR9H3SZ: digest: sha256:8c0297ce2be1e15c1b513ff41a05c613cb5c01d590db5c3200dd59df15009358 size: 2633
--> Pushing image done
image: registry.fly.io/fly-demo-test:deployment-01HY09TSQNFP1FB83CXDR9H3SZ
image size: 812 MB

Watch your deployment at https://fly.io/apps/fly-demo-test/monitoring

Provisioning ips for fly-demo-test
  Dedicated ipv6: 2a09:8280:1::35:b49f:0
  Shared ipv4: 66.241.125.58
  Add a dedicated ipv4 with: fly ips allocate-v4

This deployment will:
 * create 1 "app" machine

No machines in group app, launching a new machine
Finished launching new machines
-------
NOTE: The machines for [app] have services with 'auto_stop_machines = true' that will be stopped when idling

-------
Checking DNS configuration for fly-demo-test.fly.dev

Visit your newly deployed app at https://fly-demo-test.fly.dev/
```

ä¸Šè¨˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¾Œã®æ–¹ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«é–¢ã™ã‚‹é‡è¦ãªæƒ…å ±ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
- ç›£è¦–URLï¼ˆhttps://fly.io/apps/your-app-name/monitoringï¼‰
    - ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’é–²è¦§ã§ãã‚‹
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®URLï¼ˆhttps://your-app-name.fly.dev/ï¼‰

ç›£è¦–URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®é€šã‚ŠFastAPIãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ğŸ‰ğŸ‰
![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/319375/ac567b30-7f65-4f60-c32d-f53de3d58bb0.png)


# â‘¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«sshæ¥ç¶šã—ã¦Alembicã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹
ãŸã ã—ã€ä»Šã®çŠ¶æ…‹ã ã¨Fly.ioã«ä½œæˆã—ãŸPostgresqlã¯ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦Postgresqlã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

Fly.ioã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«sshæ¥ç¶šã—ã€ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
`flyctl ssh consoleã€€-a <app-name> -C "å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰"`

æœ¬ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦Alembicã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```bash
$ flyctl ssh console -a fastapi-zero -C "alembic upgrade head"
Connecting to fdaa:9:4109:a7b:b4f1:12d8:1709:2... complete
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 7c2f73b28d63, create user table
INFO  [alembic.runtime.migration] Running upgrade 7c2f73b28d63 -> 71bfea98db2b, create todo table
```

ãã®å¾Œã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸFastAPIã®
swagger UIï¼ˆhttps://your-app-name.fly.dev/docsï¼‰ ç­‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€DBã«å¯¾ã—ã¦CRUDæ“ä½œãŒè¡Œãˆã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚

# â‘¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰Šé™¤
ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨Postgresqlã‚’å‰Šé™¤ã—ãŸã„å ´åˆã€ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤ã§ãã¾ã™ã€‚
```shell
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‰Šé™¤
$ fly apps destroy <app-name>

# Postgresqlã®å‰Šé™¤
$ fly apps destroy <db-name>
```


# ã•ã„ã”ã«
ä»¥ä¸Šã€FastAPI/SQLAlchemy/psycopg/Alembic/PostgreSQLã®çµ„ã¿åˆã‚ã›ã‚’Fly.ioã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ‰‹é †ã®ç´¹ä»‹ã§ã—ãŸã€‚

ã“ã®çµ„ã¿åˆã‚ã›ãŒãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§ãƒãƒã‚‹äººãŒã„ã‚‹ã‹ã¯å¾®å¦™ã§ã™ãŒã€èª°ã‹ã®å½¹ã«ç«‹ã£ãŸã‚‰å¬‰ã—ã„ã§ã™ã€‚

Fly.ioã‚’ä½¿ã£ã¦ã¿ãŸæ„Ÿæƒ³ã¨ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ“ä½œã¯ç›´æ„Ÿçš„ã§ã‚„ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ã™ãŒã€Fly.ioã®Webç”»é¢ãŒã‚‚ã£ã•ã‚Šã—ã¦ã„ã‚‹ã®ãŒå°‘ã—æ°—ã«ãªã‚Šã¾ã—ãŸã€‚


[^1]: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ãªã„çŠ¶æ…‹ã§deployã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
Error: We need your payment information to continue! Add a credit card or buy credit: https://fly.io/dashboard/<ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå>/billing
